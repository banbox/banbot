# Telegram Bot 交互命令功能

BanBot 现在支持通过 Telegram Bot 进行交互式控制，可以通过命令查看订单、控制交易等。

## 功能特性

✅ **订单管理**
- 查看当前活跃订单列表
- 强制平仓指定订单
- 批量平仓所有订单

✅ **交易控制**
- 查看交易状态和订单统计
- 临时禁用开单功能（支持小时级别）
- 重新启用交易功能

✅ **安全控制**
- 基于 chat_id 的权限验证
- 自动集成到策略开单逻辑
- 实时状态检查

## 配置方式

在配置文件的 `rpc_channels` 节点下添加 Telegram 配置：

```yaml
rpc_channels:
  telegram_bot:
    type: "telegram"
    token: "YOUR_BOT_TOKEN"           # 必填：Telegram Bot Token
    chat_id: "YOUR_CHAT_ID"           # 必填：聊天ID（用户ID或群组ID）
    proxy: "http://127.0.0.1:7897"    # 可选：代理地址
    msg_types: ["entry", "exit", "status", "exception"]
    retry_delay: 30
    min_intv_secs: 5
```

### 获取 Bot Token 和 Chat ID

1. **创建 Bot Token**：
   - 在 Telegram 中找到 @BotFather
   - 发送 `/newbot` 创建新机器人
   - 按提示设置机器人名称和用户名
   - 获得 Bot Token

2. **获取 Chat ID**：
   - 将机器人添加到目标聊天（私聊或群聊）
   - 发送任意消息给机器人
   - 访问 `https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates`
   - 在返回的 JSON 中找到 `chat.id` 字段

## 支持的命令

### 交互式菜单（推荐）

| 命令 | 功能 | 说明 |
|------|------|------|
| `/menu` | 显示操作菜单 | 显示包含所有功能的交互式按钮菜单 |

**菜单功能包括：**
- 📊 查看订单 - 显示当前活跃订单列表，支持逐个平仓操作
- 📈 开单状态 - 查看交易状态统计信息
- 🚫 禁止开单 - 暂时禁用开单功能（默认1小时）
- ✅ 启用开单 - 重新启用开单功能
- ❌ 平仓所有 - 平仓所有活跃订单
- 🔄 刷新菜单 - 刷新菜单界面

> 💡 **建议优先使用 `/menu` 命令**，它提供了更直观的按钮操作界面，无需记忆复杂的命令语法。

### 订单管理

| 命令 | 功能 | 示例 |
|------|------|------|
| `/orders` | 查看当前订单列表 | `/orders` |
| `/close <订单ID>` | 平仓指定订单 | `/close 123` |
| `/close all` | 平仓所有订单 | `/close all` |

### 交易控制

| 命令 | 功能 | 示例 |
|------|------|------|
| `/status` | 查看交易状态 | `/status` |
| `/disable [小时]` | 禁用开单（默认1小时） | `/disable 2` |
| `/enable` | 重新启用开单 | `/enable` |

### 其他命令

| 命令 | 功能 | 示例 |
|------|------|------|
| `/help` | 显示帮助信息 | `/help` |

## 命令示例

### 查看订单列表
```
/orders
```
**响应示例**：
```
📊 当前订单列表
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🏷️ 账户: account1
• 123 📈 多 BTC/USDT:USDT
  💰 价格: 43250.50000 | 数量: 0.0023
  📊 盈亏: +125.50 | 标签: ma_long

• 124 📉 空 ETH/USDT:USDT
  💰 价格: 2650.25000 | 数量: 0.0377
  📊 盈亏: -45.20 | 标签: rsi_short

总计: 2 个活跃订单
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 平仓订单
```
/close 123
```
**响应示例**：
```
✅ 平仓成功

订单ID: 123
交易对: BTC/USDT:USDT
已提交平仓请求
```

### 查看交易状态
```
/status
```
**响应示例**：
```
📊 交易状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🏷️ 账户: account1
  ✅ 状态: 开单正常
  📈 多单: 1 | 📉 空单: 1

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 禁用开单
```
/disable 3
```
**响应示例**：
```
🚫 开单已禁用

⏰ 禁用时长: 3 小时
📅 恢复时间: 2024-01-15 18:30:00

使用 /enable 可提前恢复开单
```

## 安全特性

1. **权限验证**：只有配置的 `chat_id` 可以执行命令
2. **自动集成**：禁用状态会自动阻止策略开新单
3. **日志记录**：所有命令操作都会记录到日志
4. **错误处理**：命令执行失败会返回详细错误信息

## 技术实现

- 使用 `go-telegram/bot` 库实现 Bot 功能
- 支持代理配置，适应网络环境
- 异步消息处理，不阻塞主程序
- 线程安全的状态管理
- 自动重连和错误恢复

## 注意事项

1. **运行模式**：Telegram Bot 命令功能需要在以下模式下运行：
   - **实盘模式**：`./bot trade`（推荐，完整功能）
   - **回测模式**：`./bot backtest`（支持命令，但订单操作无效）
   - **爬虫模式**：`./bot spider`（支持命令，但订单操作无效）

2. **Token 安全**：请妥善保管 Bot Token，避免泄露

3. **Chat ID 验证**：确保 Chat ID 配置正确，否则无法接收命令

4. **网络环境**：如需要代理，请正确配置 `proxy` 字段

5. **权限控制**：建议使用私聊而非群聊，确保命令安全性

6. **实时性**：命令执行结果会立即反馈，但市场订单执行可能有延迟

## 故障排除

### Bot 无响应
1. **检查运行模式**：确保使用 `./bot trade`、`./bot backtest` 或 `./bot spider` 启动
2. **检查配置**：确认 `rpc_channels` 中的 Telegram 配置正确
3. **检查 Token**：验证 Bot Token 是否正确
4. **检查网络**：检查网络连接和代理设置
5. **查看日志**：查看启动日志中是否有 "Starting Telegram bot command listener" 信息

### 权限被拒绝
1. 确认 Chat ID 配置正确
2. 确保已将 Bot 添加到对话中
3. 检查是否在正确的聊天中发送命令
4. 查看日志中的 "Unauthorized telegram command attempt" 警告

### 订单操作失败
1. **检查运行模式**：订单操作只在实盘模式 (`./bot trade`) 下有效
2. **检查账户配置**：确认账户配置是否正确
3. **确认订单 ID**：验证订单 ID 是否有效和存在
4. **查看策略日志**：了解具体的错误信息

### 常见启动问题
1. **配置文件路径**：确保配置文件路径正确，使用 `-c config.yml` 指定
2. **RPC 配置缺失**：检查配置文件中是否包含 `rpc_channels.telegram_bot` 配置
3. **网络代理**：如果在国内使用，可能需要配置 `proxy` 字段
